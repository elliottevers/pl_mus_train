{"version":3,"file":"clip.js","sourceRoot":"","sources":["../../src/clip/clip.ts"],"names":[],"mappings":"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","sourcesContent":["import {note} from \"../note/note\";\nimport TreeModel = require(\"tree-model\");\n\nexport namespace clip {\n\n    export class Clip {\n\n        private clip_dao;\n\n        private notes: TreeModel.Node<note.Note>[];\n\n        constructor(clip_dao) {\n            this.clip_dao = clip_dao;\n            this.notes = null;\n        }\n\n        get_num_measures(): number {\n            return (this.get_end_marker() - this.get_start_marker()) / 4;\n        }\n\n        get_end_marker(): number {\n            return this.clip_dao.get_end_marker();\n        }\n\n        get_start_marker(): number {\n            return this.clip_dao.get_start_marker();\n        }\n\n        // TODO: annotations\n        load_notes(): void {\n            this.notes = Clip._parse_notes(this._get_notes(\n                0,\n                0,\n                this.get_end_marker(),\n                128\n            ));\n        }\n\n        // TODO: annotations\n        get_pitch_max(): number {\n            let pitch_max = 0;\n\n            for (let node of this.notes) {\n                if (node.model.note.pitch > pitch_max) {\n                    pitch_max = node.model.note.pitch;\n                }\n            }\n\n            return pitch_max;\n        }\n\n        // TODO: annotations\n        get_pitch_min(): number {\n            let pitch_min = 128;\n\n            for (let node of this.notes) {\n                if (node.model.note.pitch < pitch_min) {\n                    pitch_min = node.model.note.pitch;\n                }\n            }\n\n            return pitch_min;\n        }\n\n        get_ambitus(): number[] {\n            return [this.get_pitch_min(), this.get_pitch_max()];\n        }\n\n        set_loop_bracket_lower(beat: number): void {\n            this.clip_dao.set_loop_bracket_lower(beat);\n        }\n\n        set_loop_bracket_upper(beat: number): void {\n            this.clip_dao.set_loop_bracket_upper(beat);\n        }\n\n        set_clip_endpoint_lower(beat: number): void {\n            this.clip_dao.set_clip_endpoint_lower(beat);\n        }\n\n        set_clip_endpoint_upper(beat: number): void {\n            this.clip_dao.set_clip_endpoint_upper(beat);\n        }\n\n        fire(): void {\n            this.clip_dao.fire();\n        }\n\n        stop(): void {\n            this.clip_dao.stop();\n        }\n\n        get_notes(): TreeModel.Node<Node>[] {\n        // get_notes(beat_start: number, pitch_midi_min: number, beat_end: number, pitch_midi_max: number): TreeModel.Node<Node>[] {\n            if (!this.notes) {\n                let beat_start, pitch_midi_min, beat_end, pitch_midi_max;\n                beat_start = 0;\n                beat_end = this.get_end_marker();\n                pitch_midi_min = 0;\n                pitch_midi_max = 128;\n                return Clip._parse_notes(\n                    this._get_notes(\n                        beat_start,\n                        pitch_midi_min,\n                        beat_end,\n                        pitch_midi_max\n                    )\n                );\n            } else {\n                return this.notes;\n            }\n        }\n\n        private _get_notes(beat_start: number, pitch_midi_min: number, beat_end: number, pitch_midi_max: number): string[] {\n            return this.clip_dao.get_notes(\n                beat_start,\n                pitch_midi_min,\n                beat_end,\n                pitch_midi_max\n            )\n        }\n\n        // TODO: return list of tree nodes\n        private static _parse_notes(notes: string[]): TreeModel.Node<note.Note>[] {\n            let data: any = [];\n            let notes_parsed = [];\n\n            let pitch;\n            let beat_start;\n            let beats_duration;\n            let velocity;\n            let b_muted;\n\n            let index_num_expected_notes = null;\n\n            for (var i = 0; i < notes.length; i++) {\n\n                if (notes[i] === 'done') {\n                    continue;\n                }\n\n                if (notes[i] === 'note') {\n                    data = [];\n                    continue;\n                }\n\n                if (notes[i] === 'notes') {\n                    data = [];\n                    continue;\n                }\n\n                if (i === index_num_expected_notes) {\n                    data = [];\n                    continue;\n                }\n\n                data.push(notes[i]);\n\n                if (data.length === 5) {\n\n                    pitch = data[0];\n                    beat_start = data[1];\n                    beats_duration = data[2];\n                    velocity = data[3];\n                    b_muted = data[4];\n\n                    let tree: TreeModel = new TreeModel();\n\n                    notes_parsed.push(\n                        tree.parse(\n                            {\n                                id: -1, // TODO: hashing scheme for clip id and beat start\n                                note: new note.Note(\n                                    pitch,\n                                    beat_start,\n                                    beats_duration,\n                                    velocity,\n                                    b_muted\n                                ),\n                                children: [\n\n                                ]\n                            }\n                        )\n                    );\n                }\n            }\n\n            function compare(note_former,note_latter) {\n                if (note_former.model.note.beat_start < note_latter.model.note.beat_start)\n                    return -1;\n                if (note_former.model.note.beat_start > note_latter.model.note.beat_start)\n                    return 1;\n                return 0;\n            }\n\n            notes_parsed.sort(compare);\n\n            // TODO: fail gracefully\n            // if (notes_parsed.length !== num_expected_notes) {\n            //     throw \"notes retrieved from clip less than expected\"\n            // }\n\n            // l.log(notes_parsed);\n            return notes_parsed;\n        }\n    }\n\n    interface implementsLiveAPI {\n        get(): any;\n        set(): void;\n        call(): void;\n    }\n\n    export class ClipDao {\n\n        private clip_live;\n        private messenger;\n        private deferlow: boolean;\n\n        // how to implement LiveAPI - get, set, call\n\n        constructor(clip_live: implementsLiveAPI, messenger, deferlow: boolean) {\n            // let path = \"live_set tracks \" + index_track + \" clip_slots \" + index_clip_slot + \" clip\";\n            // this.clip_live = new LiveAPI(null, path);\n            this.clip_live = clip_live;\n            this.messenger = messenger;\n            this.deferlow = deferlow;\n        }\n\n        // TODO: check if these actually return arrays\n        get_end_marker(): number {\n            return this.clip_live.get('end_marker')[0];\n        }\n\n        // TODO: check if these actually return arrays\n        get_start_marker(): number {\n            return this.clip_live.get('start_marker')[0];\n        }\n\n        set_loop_bracket_lower(beat: number) {\n            if (this.deferlow) {\n                this.messenger.message([\"clip_endpoints\", \"loop_start\", beat, \"set\"])\n            } else {\n                this.clip_live.set('loop_start', beat);\n            }\n        }\n\n        set_loop_bracket_upper(beat: number) {\n            if (this.deferlow) {\n                this.messenger.message([\"clip_endpoints\", \"loop_end\", beat, \"set\"])\n            } else {\n                this.clip_live.set('loop_end', beat);\n            }\n        }\n\n        set_clip_endpoint_lower(beat: number) {\n            if (this.deferlow) {\n                this.messenger.message([\"clip_endpoints\", \"start_marker\", beat, \"set\"])\n            } else {\n                this.clip_live.set('start_marker', beat);\n            }\n        }\n\n        set_clip_endpoint_upper(beat: number) {\n            if (this.deferlow) {\n                this.messenger.message([\"clip_endpoints\", \"end_marker\", beat, \"set\"])\n            } else {\n                this.clip_live.set('end_marker', beat);\n            }\n        }\n\n        fire(): void {\n            if (this.deferlow) {\n                this.messenger.message([\"clip_endpoints\", \"fire\", \"call\"])\n            } else {\n                this.clip_live.call('fire');\n            }\n        };\n\n        stop(): void {\n            if (this.deferlow) {\n                this.messenger.message([\"clip_endpoints\", \"stop\", \"call\"])\n            } else {\n                this.clip_live.call('stop');\n            }\n        };\n\n        get_notes(beat_start, pitch_midi_min, beat_end, pitch_midi_max): string[] {\n            return this.clip_live.call(\n                'get_notes',\n                beat_start,\n                pitch_midi_min,\n                beat_end,\n                pitch_midi_max\n            );\n        };\n\n    }\n}"]}